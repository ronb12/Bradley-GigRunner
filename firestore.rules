rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ✅ Users - Self-access only (simplified for now)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ✅ Delivery Requests - Allow workers to read all, write assigned ones
    match /requests/{requestId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        // Customer can write their own requests
        resource.data.userId == request.auth.uid ||
        // Worker can write if assigned to them
        resource.data.assignedWorker == request.auth.uid ||
        // Admin can write any request
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin'])
      );
    }

    // ✅ Request Chat Messages - Allow participants to read/write
    match /requests/{requestId}/messages/{messageId} {
      allow read, write: if request.auth != null && (
        // Customer can access their own requests
        get(/databases/$(database)/documents/requests/$(requestId)).data.userId == request.auth.uid ||
        // Worker can access if assigned
        get(/databases/$(database)/documents/requests/$(requestId)).data.assignedWorker == request.auth.uid ||
        // Admin can access any
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin'])
      );
    }

    // ✅ Request Meta - Same as requests
    match /requests/{requestId}/meta/{metaId} {
      allow read, write: if request.auth != null;
    }

    // ✅ Worker Hires - Allow workers to read their hires
    match /workerHires/{hireId} {
      allow read, write: if request.auth != null && (
        // Customer can access their own hires
        resource.data.customerId == request.auth.uid ||
        // Worker can access if hired
        resource.data.workerId == request.auth.uid ||
        // Admin can access any
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['admin'])
      );
    }

    // ✅ Logs - Simplified
    match /logs/{logId} {
      allow read, write: if request.auth != null;
    }

    // ✅ Notifications for users
    match /users/{userId}/notifications/{notifId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}







