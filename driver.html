<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bradley GigRunner - Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="favicon.ico" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #1a4d2e; }
    button {
      padding: 10px 16px;
      background: #1a4d2e;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #145032; }
    .job-card {
      background: white;
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
    }
    #map {
      height: 300px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    #earningsSummary {
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Driver Dashboard</h1>
  <button onclick="logout()">Logout</button>
  <button onclick="showProfile()">Profile</button>
  <button onclick="toggleAvailability()">Toggle Availability</button>

  <h2>Earnings Summary</h2>
  <div id="earningsSummary">Loading...</div>

  <h2>My Jobs</h2>
  <div id="jobList">Loading...</div>

  <!-- Map Modal -->
  <div id="mapModal" class="modal" onclick="if(event.target==this) closeMap()">
    <div class="modal-content">
      <h3>Live Route</h3>
      <div id="map"></div>
      <button onclick="closeMap()">Close</button>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal" onclick="if(event.target==this) closeChat()">
    <div class="modal-content">
      <h3>Chat</h3>
      <div id="chatMessages" style="height:200px; overflow-y:auto; border:1px solid #ccc; padding:10px;"></div>
      <input id="chatInput" type="text" style="width:100%; margin-top:10px;" placeholder="Type message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Firebase Init -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBYJkHvoa43DbF5Wn_a8uGZ9o_olCMnuFc",
      authDomain: "bradley-gigrunner.firebaseapp.com",
      projectId: "bradley-gigrunner",
      storageBucket: "bradley-gigrunner.appspot.com",
      messagingSenderId: "497753581430",
      appId: "1:497753581430:web:db6c22866194dd3285bc57"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
  <script>
    let currentUserId = null;
    let activeChatJobId = null;
    let mapInstance = null;
    let routeLayer = null;
    let carMarker = null;

    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = "login.html";
      currentUserId = user.uid;
      loadJobs();
      loadEarnings();
    });

    function logout() {
      auth.signOut().then(() => location.href = "login.html");
    }

    function showProfile() {
      alert("Profile modal coming soon!");
    }

    function toggleAvailability() {
      alert("Driver availability toggled.");
    }

    function loadJobs() {
      const jobList = document.getElementById("jobList");
      jobList.innerHTML = "Loading...";
      db.collection("requests")
        .where("driverId", "==", currentUserId)
        .orderBy("timestamp", "desc")
        .onSnapshot(snapshot => {
          if (snapshot.empty) {
            jobList.innerHTML = "<p>No jobs assigned yet.</p>";
            return;
          }
          jobList.innerHTML = "";
          snapshot.forEach(doc => {
            const d = doc.data();
            const tip = d.tip?.toFixed(2) || "0.00";
            const payout = (d.basePay || 0).toFixed(2);
            const fuel = (d.fuelCost || 0).toFixed(2);
            const maint = (d.maintCost || 0).toFixed(2);
            jobList.innerHTML += `
              <div class="job-card">
                <p><strong>Pickup:</strong> ${d.pickup}</p>
                <p><strong>Dropoff:</strong> ${d.dropoff}</p>
                <p><strong>Status:</strong> ${d.status}</p>
                <p><strong>Paid:</strong> ${d.paid ? "‚úÖ" : "‚ùå"}</p>
                <p><strong>Payout:</strong> $${payout}</p>
                <p><strong>Tip:</strong> $${tip}</p>
                <p><strong>Fuel:</strong> $${fuel} ‚Ä¢ <strong>Maint:</strong> $${maint}</p>
                <button onclick="startMap('${d.pickup}', '${d.dropoff}')">üß≠ Navigate</button>
                <button onclick="openChat('${doc.id}')">üí¨ Chat</button>
              </div>
            `;
          });
        });
    }

    function startMap(pickup, dropoff) {
      document.getElementById("mapModal").style.display = "flex";

      if (mapInstance) {
        mapInstance.remove();
        mapInstance = null;
      }

      mapInstance = L.map("map").setView([34.0007, -81.0348], 13); // Columbia, SC
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap"
      }).addTo(mapInstance);

      const pickupCoord = [34.002, -81.030];
      const dropoffCoord = [34.009, -81.032];

      routeLayer = L.polyline([pickupCoord, dropoffCoord], { color: "blue" }).addTo(mapInstance);
      carMarker = L.marker(pickupCoord, {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/744/744465.png",
          iconSize: [32, 32]
        })
      }).addTo(mapInstance);

      animateCar(pickupCoord, dropoffCoord);
    }

    function animateCar(start, end) {
      let t = 0;
      const interval = setInterval(() => {
        if (t >= 1) return clearInterval(interval);
        const lat = start[0] + (end[0] - start[0]) * t;
        const lng = start[1] + (end[1] - start[1]) * t;
        carMarker.setLatLng([lat, lng]);
        t += 0.01;
      }, 100);
    }

    function closeMap() {
      document.getElementById("mapModal").style.display = "none";
    }

    function openChat(jobId) {
      activeChatJobId = jobId;
      document.getElementById("chatModal").style.display = "flex";
      const chatBox = document.getElementById("chatMessages");
      chatBox.innerHTML = "Loading...";
      db.collection(`requests/${jobId}/messages`)
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          chatBox.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            const time = msg.timestamp?.seconds ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString() : "";
            chatBox.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.text} <small>${time}</small></p>`;
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    function sendMessage() {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text || !activeChatJobId) return;
      db.collection(`requests/${activeChatJobId}/messages`).add({
        text,
        sender: "Driver",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      input.value = "";
    }

    function closeChat() {
      document.getElementById("chatModal").style.display = "none";
      document.getElementById("chatMessages").innerHTML = "";
    }

    function loadEarnings() {
      db.collection("requests")
        .where("driverId", "==", currentUserId)
        .where("paid", "==", true)
        .onSnapshot(snapshot => {
          let tips = 0, fuel = 0, maint = 0, payout = 0;
          snapshot.forEach(doc => {
            const d = doc.data();
            tips += d.tip || 0;
            fuel += d.fuelCost || 0;
            maint += d.maintCost || 0;
            payout += (d.basePay || 0);
          });
          const total = tips + payout + fuel + maint;
          document.getElementById("earningsSummary").innerHTML = `
            <strong>Total Earned:</strong> $${total.toFixed(2)}<br/>
            Tips: $${tips.toFixed(2)} ‚Ä¢ Fuel: $${fuel.toFixed(2)} ‚Ä¢ Maint: $${maint.toFixed(2)}
          `;
        });
    }
  </script>
</body>
</html>
