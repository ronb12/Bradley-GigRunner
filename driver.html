<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bradley GigRunner - Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="favicon.ico" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #1a4d2e; }
    button {
      padding: 10px 16px;
      background: #1a4d2e;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover { background: #145032; }
    .job-card {
      background: white;
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      font-size: 1em;
    }
    #map {
      height: 300px;
      width: 100%;
      margin: 10px 0;
      border-radius: 8px;
    }
    .earnings-summary {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .right { float: right; }
    .profile-pic {
      max-width: 100%;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h1>Driver Dashboard</h1>
  <button onclick="logout()">Logout</button>
  <button onclick="showProfileModal()">Profile</button>
  <button onclick="toggleAvailability()">Toggle Availability</button>

  <h2>Earnings Summary</h2>
  <div class="earnings-summary" id="earningsBox">Calculating...</div>

  <h2>My Jobs</h2>
  <div id="jobList">Loading jobs...</div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal" onclick="if(event.target==this) closeProfileModal()">
    <div class="modal-content">
      <h3>Edit Profile</h3>
      <input type="text" id="driverName" placeholder="Full Name" />
      <input type="email" id="driverEmail" placeholder="Email" />
      <input type="text" id="driverPhone" placeholder="Phone Number" />
      <input type="text" id="driverVehicle" placeholder="Vehicle Info" />
      <label>Upload Photo ID:</label>
      <input type="file" id="photoUpload" accept="image/*" />
      <img id="photoPreview" class="profile-pic" src="" alt="ID Preview" />
      <button onclick="saveProfile()">Save Profile</button>
      <button onclick="closeProfileModal()" style="margin-top:10px;">Close</button>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBYJkHvoa43DbF5Wn_a8uGZ9o_olCMnuFc",
      authDomain: "bradley-gigrunner.firebaseapp.com",
      projectId: "bradley-gigrunner",
      storageBucket: "bradley-gigrunner.appspot.com",
      messagingSenderId: "497753581430",
      appId: "1:497753581430:web:db6c22866194dd3285bc57"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    let currentUserId = null;

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = "login.html";
      const docSnap = await db.collection("users").doc(user.uid).get();
      if (!docSnap.exists || !(docSnap.data().roles || []).includes("driver")) {
        alert("Access denied");
        return auth.signOut();
      }
      currentUserId = user.uid;
      loadJobs();
      loadEarnings();
      loadProfile();
    });

    function logout() {
      auth.signOut().then(() => location.href = "login.html");
    }

    function toggleAvailability() {
      alert("Availability toggled (demo only)");
    }

    function showProfileModal() {
      document.getElementById("profileModal").style.display = "flex";
    }

    function closeProfileModal() {
      document.getElementById("profileModal").style.display = "none";
    }

    async function saveProfile() {
      const name = document.getElementById("driverName").value;
      const email = document.getElementById("driverEmail").value;
      const phone = document.getElementById("driverPhone").value;
      const vehicle = document.getElementById("driverVehicle").value;
      await db.collection("users").doc(currentUserId).update({ name, email, phone, vehicle });
      const file = document.getElementById("photoUpload").files[0];
      if (file) {
        const ref = storage.ref(`ids/${currentUserId}.jpg`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        document.getElementById("photoPreview").src = url;
      }
      alert("Profile updated!");
      closeProfileModal();
    }

    async function loadProfile() {
      const docSnap = await db.collection("users").doc(currentUserId).get();
      const data = docSnap.data();
      document.getElementById("driverName").value = data.name || "";
      document.getElementById("driverEmail").value = data.email || "";
      document.getElementById("driverPhone").value = data.phone || "";
      document.getElementById("driverVehicle").value = data.vehicle || "";
      try {
        const url = await storage.ref(`ids/${currentUserId}.jpg`).getDownloadURL();
        document.getElementById("photoPreview").src = url;
      } catch {}
    }

    function loadJobs() {
      const list = document.getElementById("jobList");
      db.collection("requests").where("driverId", "==", currentUserId).onSnapshot(snapshot => {
        list.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          const fuel = (d.distance * 0.2).toFixed(2);
          const maint = (d.distance * 0.08).toFixed(2);
          const payout = (d.basePay + d.tip).toFixed(2);
          list.innerHTML += `
            <div class="job-card">
              <p><strong>Pickup:</strong> ${d.pickup}</p>
              <p><strong>Dropoff:</strong> ${d.dropoff}</p>
              <p><strong>Status:</strong> ${d.status}</p>
              <p><strong>Paid:</strong> ${d.paid ? "‚úÖ" : "‚ùå"}</p>
              <p><strong>Tip:</strong> $${d.tip.toFixed(2)}</p>
              <p><strong>Payout:</strong> $${payout}</p>
              <p><strong>Fuel:</strong> $${fuel} ‚Ä¢ <strong>Maint:</strong> $${maint}</p>
              <button onclick="showMap('${d.pickup}', '${d.dropoff}')">üìç View Route</button>
            </div>`;
        });
      });
    }

    function showMap(pickup, dropoff) {
      const mapBox = document.createElement("div");
      mapBox.id = "map";
      document.body.appendChild(mapBox);
      const map = L.map("map").setView([34.0007, -81.0348], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      // Dummy coordinates; replace with real geocode logic later
      const pickupMarker = L.marker([34.0007, -81.0348]).addTo(map).bindPopup(pickup).openPopup();
      const dropoffMarker = L.marker([34.0107, -81.0448]).addTo(map).bindPopup(dropoff);
      const carIcon = L.icon({ iconUrl: "car-icon.png", iconSize: [32, 32] });
      const car = L.marker([34.0007, -81.0348], { icon: carIcon }).addTo(map);
      let i = 0;
      const interval = setInterval(() => {
        if (i >= 100) return clearInterval(interval);
        car.setLatLng([34.0007 + i * 0.0001, -81.0348 + i * 0.0001]);
        i++;
      }, 150);
    }

    function loadEarnings() {
      db.collection("requests").where("driverId", "==", currentUserId).where("paid", "==", true).onSnapshot(snapshot => {
        let total = 0, tips = 0, fuel = 0, maint = 0;
        snapshot.forEach(doc => {
          const d = doc.data();
          total += d.basePay + d.tip;
          tips += d.tip;
          fuel += d.distance * 0.2;
          maint += d.distance * 0.08;
        });
        document.getElementById("earningsBox").innerHTML = `
          <p><strong>Total Earned:</strong> $${total.toFixed(2)}</p>
          <p>Tips: $${tips.toFixed(2)} ‚Ä¢ Fuel: $${fuel.toFixed(2)} ‚Ä¢ Maint: $${maint.toFixed(2)}</p>
        `;
      });
    }
  </script>
</body>
</html>
