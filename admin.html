<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard ‚Äì Bradley GigRunner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.ico" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #1a4d2e;
      text-align: center;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      background: #ddd;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .tab-button.active {
      background: #1a4d2e;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background: #e0f0e9;
    }
    button {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .action-btn {
      background: #1a4d2e;
      color: white;
    }
    .delete-btn {
      background: #d9534f;
      color: white;
    }
    .generate-btn {
      background: #145032;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <div class="tabs">
    <button class="tab-button active" onclick="showTab('requestsTab')">üìù Requests</button>
    <button class="tab-button" onclick="showTab('recurringTab')">üîÅ Recurring Jobs</button>
    <button class="tab-button" onclick="showTab('earningsTab')">üìä Earnings</button>
  </div>

  <!-- Requests Tab -->
  <div id="requestsTab" class="tab-content active">
    <div class="box">
      <h2>Delivery Requests</h2>
      <table>
        <thead>
          <tr>
            <th>Pickup</th>
            <th>Dropoff</th>
            <th>Driver</th>
            <th>Status</th>
            <th>Paid</th>
            <th>Assign</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="requestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Recurring Jobs Tab -->
  <div id="recurringTab" class="tab-content">
    <div class="box">
      <h2>Recurring Jobs</h2>
      <table>
        <thead>
          <tr>
            <th>Customer</th>
            <th>Pickup</th>
            <th>Dropoff</th>
            <th>Interval</th>
            <th>Next Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recurringTable"></tbody>
      </table>
      <button class="action-btn" onclick="createRecurring()">‚ûï Add Recurring Job</button>
    </div>
  </div>

  <!-- Earnings Report Tab -->
  <div id="earningsTab" class="tab-content">
    <div class="box">
      <h2>Earnings Report Generator</h2>
      <label>Start Date: <input type="date" id="startDate" /></label>
      <label>End Date: <input type="date" id="endDate" /></label>
      <button class="generate-btn" onclick="generateEarningsReport()">üìÑ Generate Report</button>
      <div id="earningsResult" style="margin-top: 15px;"></div>
    </div>
  </div>

  <!-- Modals, Scripts, and Part 2 continues... -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, updateDoc, deleteDoc,
      query, where, orderBy, onSnapshot, addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYJkHvoa43DbF5Wn_a8uGZ9o_olCMnuFc",
      authDomain: "bradley-gigrunner.firebaseapp.com",
      projectId: "bradley-gigrunner",
      storageBucket: "bradley-gigrunner.appspot.com",
      messagingSenderId: "497753581430",
      appId: "1:497753581430:web:db6c22866194dd3285bc57"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    let currentAdminId = null;

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "login.html";
      const userDoc = await getDoc(doc(db, "users", user.uid));
      const roles = userDoc.exists() ? (userDoc.data().roles || []) : [];
      if (!roles.includes("admin")) {
        alert("Access denied.");
        await signOut(auth);
        return location.href = "login.html";
      }
      currentAdminId = user.uid;
      loadRequests();
      loadRecurringJobs();
    });

    window.logout = () => signOut(auth).then(() => location.href = "login.html");

    function showTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      event.target.classList.add("active");
    }

    async function loadRequests() {
      const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));
      onSnapshot(q, async snapshot => {
        const tbody = document.getElementById("requestsTable");
        tbody.innerHTML = "";
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          tbody.innerHTML += `
            <tr>
              <td>${d.pickup}</td>
              <td>${d.dropoff}</td>
              <td>${d.driver || "Unassigned"}</td>
              <td>${d.status}</td>
              <td>${d.paid ? "‚úÖ" : "‚ùå"}</td>
              <td><input type="text" value="${d.driver || ""}" onchange="assignDriver('${docSnap.id}', this.value)" /></td>
              <td>
                <button class="delete-btn" onclick="deleteRequest('${docSnap.id}')">üóë</button>
              </td>
            </tr>`;
        });
      });
    }

    window.assignDriver = async (requestId, driverId) => {
      await updateDoc(doc(db, "requests", requestId), { driver: driverId });
    };

    window.deleteRequest = async (id) => {
      if (confirm("Delete this request?")) await deleteDoc(doc(db, "requests", id));
    };

    async function loadRecurringJobs() {
      const q = query(collection(db, "recurring_jobs"));
      const snapshot = await getDocs(q);
      const tbody = document.getElementById("recurringTable");
      tbody.innerHTML = "";
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        tbody.innerHTML += `
          <tr>
            <td>${d.customerId}</td>
            <td>${d.pickup}</td>
            <td>${d.dropoff}</td>
            <td>${d.interval}</td>
            <td>${d.nextRun}</td>
            <td><button class="delete-btn" onclick="deleteRecurring('${docSnap.id}')">üóë</button></td>
          </tr>`;
      });
    }

    window.deleteRecurring = async (id) => {
      if (confirm("Delete this recurring job?")) await deleteDoc(doc(db, "recurring_jobs", id));
    };

    window.createRecurring = async () => {
      const customerId = prompt("Customer ID:");
      const pickup = prompt("Pickup Location:");
      const dropoff = prompt("Dropoff Location:");
      const interval = prompt("Interval (e.g., weekly):");
      const nextRun = prompt("Next Date (YYYY-MM-DD):");

      if (!customerId || !pickup || !dropoff || !interval || !nextRun) return alert("All fields required.");
      await addDoc(collection(db, "recurring_jobs"), {
        customerId, pickup, dropoff, interval, nextRun
      });
      loadRecurringJobs();
    };

    window.generateEarningsReport = async () => {
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      if (!start || !end) return alert("Pick both dates.");
      const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      let total = 0, count = 0;

      snapshot.forEach(doc => {
        const d = doc.data();
        if (d.timestamp?.seconds) {
          const t = new Date(d.timestamp.seconds * 1000);
          if (t >= start && t <= end) {
            total += (d.payout || 0) + (d.tip || 0);
            count++;
          }
        }
      });

      document.getElementById("earningsResult").innerHTML = `
        <p><strong>Jobs:</strong> ${count}</p>
        <p><strong>Total Earnings:</strong> $${total.toFixed(2)}</p>
      `;
    };
  </script>
</body>
</html>
