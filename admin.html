<!-- Part 1: Admin Dashboard - Header, Filters, Table Structure, and Analytics -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard ‚Äì Bradley GigRunner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.ico" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #1a4d2e;
      text-align: center;
    }
    .analytics {
      text-align: center;
      margin: 10px 0;
    }
    .analytics span {
      margin: 0 10px;
      font-weight: bold;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin: 10px 0;
    }
    .filters label {
      margin: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background: #e0f0e9;
    }
    .action-btn {
      background: #1a4d2e;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-btn {
      background: #d9534f;
    }
    .logout {
      float: right;
      background: #d9534f;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <div class="analytics">
    <span>Total Jobs: <span id="totalJobs">0</span></span>
    <span>Completed: <span id="completedJobs">0</span></span>
    <span>Total Payout: $<span id="totalPayout">0.00</span></span>
  </div>
  <div class="filters">
    <label>Status:
      <select id="statusFilter" onchange="filterJobs()">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="accepted">Accepted</option>
        <option value="completed">Completed</option>
      </select>
    </label>
    <label>Date:
      <input type="date" id="startDate" onchange="filterJobs()" />
      to
      <input type="date" id="endDate" onchange="filterJobs()" />
    </label>
    <label><button onclick="exportPDF()">üìÑ Export PDF</button></label>
    <label><button class="logout" onclick="logout()">Logout</button></label>
  </div>
  <table>
    <thead>
      <tr>
        <th>Pickup</th>
        <th>Dropoff</th>
        <th>Status</th>
        <th>Paid</th>
        <th>Tip</th>
        <th>Payout</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="jobTable"></tbody>
  </table>
  <!-- Edit Modal -->
  <div id="editModal" class="modal" onclick="if(event.target==this) closeModal()">
    <div class="modal-content">
      <h3>Edit Request</h3>
      <label>Driver:
        <input type="text" id="editDriver" />
      </label>
      <label>Status:
        <select id="editStatus">
          <option value="pending">Pending</option>
          <option value="accepted">Accepted</option>
          <option value="completed">Completed</option>
        </select>
      </label>
      <button onclick="saveEdit()">üíæ Save</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, getDoc, updateDoc, deleteDoc, doc, query, where
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYJkHvoa43DbF5Wn_a8uGZ9o_olCMnuFc",
      authDomain: "bradley-gigrunner.firebaseapp.com",
      projectId: "bradley-gigrunner"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let requests = [];
    let editId = null;

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = "login.html";
      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists() || !(snap.data().roles || []).includes("admin")) {
        alert("Access denied"); await signOut(auth); return location.href = "login.html";
      }
      loadJobs();
    });

    async function loadJobs() {
      const q = query(collection(db, "requests"));
      const snap = await getDocs(q);
      requests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderJobs();
    }

    function renderJobs(filtered = requests) {
      const tbody = document.getElementById("jobTable");
      tbody.innerHTML = "";
      let total = 0, completed = 0, payoutSum = 0;
      filtered.forEach(r => {
        total++;
        if (r.status === "completed") completed++;
        payoutSum += r.payout || 0;
        const date = r.timestamp?.seconds ? new Date(r.timestamp.seconds * 1000).toLocaleString() : "‚Äî";
        tbody.innerHTML += `
          <tr>
            <td>${r.pickup}</td>
            <td>${r.dropoff}</td>
            <td>${r.status}</td>
            <td>${r.paid ? "‚úÖ" : "‚ùå"}</td>
            <td>$${r.tip?.toFixed(2) || "0.00"}</td>
            <td>$${r.payout?.toFixed(2) || "0.00"}</td>
            <td>${date}</td>
            <td>
              <button class="action-btn" onclick="editJob('${r.id}')">‚úèÔ∏è</button>
              <button class="delete-btn action-btn" onclick="deleteJob('${r.id}')">üóë</button>
            </td>
          </tr>`;
      });
      document.getElementById("totalJobs").textContent = total;
      document.getElementById("completedJobs").textContent = completed;
      document.getElementById("totalPayout").textContent = payoutSum.toFixed(2);
    }

    function filterJobs() {
      const status = document.getElementById("statusFilter").value;
      const start = document.getElementById("startDate").valueAsDate;
      const end = document.getElementById("endDate").valueAsDate;
      renderJobs(requests.filter(r => {
        const t = r.timestamp?.seconds ? new Date(r.timestamp.seconds * 1000) : null;
        return (!status || r.status === status) &&
          (!start || (t && t >= start)) &&
          (!end || (t && t <= end));
      }));
    }

    function logout() {
      signOut(auth).then(() => location.href = "login.html");
    }

    function editJob(id) {
      editId = id;
      const job = requests.find(r => r.id === id);
      if (!job) return;
      document.getElementById("editDriver").value = job.driver || "";
      document.getElementById("editStatus").value = job.status;
      document.getElementById("editModal").style.display = "flex";
    }

    async function saveEdit() {
      const driver = document.getElementById("editDriver").value;
      const status = document.getElementById("editStatus").value;
      if (!editId) return;
      await updateDoc(doc(db, "requests", editId), { driver, status });
      document.getElementById("editModal").style.display = "none";
      loadJobs();
    }

    async function deleteJob(id) {
      if (confirm("Delete this request?")) {
        await deleteDoc(doc(db, "requests", id));
        loadJobs();
      }
    }

    function closeModal() {
      document.getElementById("editModal").style.display = "none";
    }

    function exportPDF() {
      const doc = new jsPDF();
      doc.text("Job Report", 10, 10);
      let y = 20;
      requests.forEach(r => {
        const line = `${r.pickup} ‚Üí ${r.dropoff} | ${r.status} | $${(r.payout || 0).toFixed(2)} | Tip: $${(r.tip || 0).toFixed(2)}`;
        doc.text(line, 10, y);
        y += 10;
      });
      doc.save("jobs_report.pdf");
    }
  </script>
</body>
</html>
